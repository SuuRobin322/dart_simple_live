name: Auto Build Windows Exe

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: Find Project and Compile
        run: |
          # 1. 自动查找 pubspec.yaml 的位置
          echo "正在搜索 pubspec.yaml..."
          $pubspec = Get-ChildItem -Path . -Filter pubspec.yaml -Recurse | Select-Object -First 1
          
          if ($null -eq $pubspec) {
            echo "❌ 严重错误：在整个仓库中都找不到 pubspec.yaml！请确认你是否正确 Fork 了代码。"
            exit 1
          }

          # 2. 进入该目录
          $projectDir = $pubspec.DirectoryName
          echo "✅ 找到项目路径: $projectDir"
          cd $projectDir

          # 3. 安装依赖
          echo "正在安装依赖..."
          dart pub get

          # 4. 确认入口文件 (通常是 bin/main.dart 或 bin/dart_simple_live.dart)
          # 这里尝试自动探测 bin 下的 .dart 文件
          $entryFile = Get-ChildItem -Path "bin" -Filter "*.dart" | Select-Object -First 1
          if ($null -eq $entryFile) {
             echo "❌ 错误：在 bin 文件夹下找不到 .dart 入口文件。"
             exit 1
          }
          echo "✅ 找到入口文件: $($entryFile.FullName)"

          # 5. 编译
          echo "开始编译..."
          dart compile exe "$($entryFile.FullName)" -o "$env:GITHUB_WORKSPACE\simple_live.exe"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: simple_live_windows
          path: simple_live.exe

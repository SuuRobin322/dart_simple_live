name: Build Flutter Windows App

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Enable Windows Build
        run: flutter config --enable-windows-desktop

      - name: Find Project and Build
        run: |
          # 1. å¯»æ‰¾åŒ…å« pubspec.yaml çš„æ–‡ä»¶å¤¹ (é€šå¸¸æ˜¯ simple_live_app)
          echo "ğŸ” æ­£åœ¨æœç´¢ Flutter é¡¹ç›®..."
          $pubspec = Get-ChildItem -Path . -Filter pubspec.yaml -Recurse | Select-Object -First 1
          
          if ($null -eq $pubspec) {
            echo "âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ° pubspec.yaml æ–‡ä»¶ï¼"
            exit 1
          }

          $projectDir = $pubspec.DirectoryName
          echo "âœ… æ‰¾åˆ°é¡¹ç›®è·¯å¾„: $projectDir"
          cd $projectDir

          # 2. å®‰è£…ä¾èµ–
          echo "ğŸ“¦ æ­£åœ¨å®‰è£…ä¾èµ–..."
          flutter pub get

          # 3. å¼€å§‹ç¼–è¯‘ Windows ç‰ˆæœ¬
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘ Windows ç‰ˆæœ¬ (è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ)..."
          flutter build windows --release

          # 4. å‡†å¤‡æ‰“åŒ…
          # Flutter ç¼–è¯‘åçš„æ–‡ä»¶é€šå¸¸åœ¨ build/windows/x64/runner/Release (æ–°ç‰ˆå¯èƒ½è·¯å¾„ç•¥æœ‰ä¸åŒï¼Œè¿™é‡Œåšä¸ªæ£€æŸ¥)
          $buildPath = "$projectDir\build\windows\x64\runner\Release"
          
          if (-not (Test-Path $buildPath)) {
             # å°è¯•å¦ä¸€ä¸ªå¯èƒ½çš„è·¯å¾„
             $buildPath = "$projectDir\build\windows\runner\Release"
          }

          if (Test-Path $buildPath) {
             echo "âœ… ç¼–è¯‘æˆåŠŸï¼Œè¾“å‡ºè·¯å¾„: $buildPath"
             
             # 5. å‹ç¼©æˆ ZIP (å› ä¸º .exe å¿…é¡»é…åˆé‡Œé¢çš„ .dll æ‰èƒ½è¿è¡Œï¼Œä¸èƒ½åªæ‹¿ä¸€ä¸ªæ–‡ä»¶)
             $zipPath = "$env:GITHUB_WORKSPACE\SimpleLive_Windows.zip"
             Compress-Archive -Path "$buildPath\*" -DestinationPath $zipPath
             echo "ğŸ“¦ å·²å‹ç¼©ä¸º: $zipPath"
          } else {
             echo "âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°ç¼–è¯‘åçš„è¾“å‡ºæ–‡ä»¶å¤¹ã€‚"
             exit 1
          }

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SimpleLive_Windows_Package
          path: SimpleLive_Windows.zip
